{% assign emptyarray = "" | split: "," %}
{% assign items = site.data[include.data] | default: emptyarray %}
{% assign items = items | data_filter: include.filter %}
{% assign items = items | gallery_sort: true %}
{% assign banner_items = items | where: "style", "banner" %}
{% assign grid_items = items | where_exp: "item", "item.style != 'banner'" %}
{% assign cache_bust = site.data.watermark_build.nonce | default: site.time | date: "%s" %}
{% assign watermark_enabled = site.watermark.enabled | default: false %}
{% assign watermark_prefix = site.watermark.prefix | default: "images/wm/" %}
{% assign watermark_thumb_prefix = watermark_prefix | append: "thumb/" %}
{% assign watermark_mode = include.watermark | default: "" %}
{% assign watermark_tags_raw = include.watermark_tags | default: "" %}
{% assign watermark_tags = watermark_tags_raw | split: "," %}

{% if banner_items.size > 0 %}
  <div class="gallery-banner" data-gallery>
    {% for item in banner_items %}
      {% assign title = item.title | default: "" %}
      {% assign subtitle = item.subtitle | default: "" %}
      {% assign image = item.image | default: "" %}
      {% assign image_rel = image %}
      {% assign image_first = image_rel | slice: 0, 1 %}
      {% if image_first == "/" %}
        {% assign image_rel = image_rel | slice: 1, 9999 %}
      {% endif %}
      {% assign wm_candidate = image_rel | replace_first: "images/", watermark_prefix %}
      {% assign wm_image = wm_candidate | file_exists %}
      {% if wm_image == nil %}
        {% assign tiff_ext = image_rel | slice: -5, 5 | downcase %}
        {% if tiff_ext == ".tiff" or image_rel | slice: -4, 4 | downcase == ".tif" %}
          {% assign wm_candidate = wm_candidate | replace: ".tiff", ".png" | replace: ".tif", ".png" %}
          {% assign wm_image = wm_candidate | file_exists %}
        {% else %}
          {% assign ext5 = image_rel | slice: -5, 5 | downcase %}
          {% if ext5 == ".heif" or ext5 == ".heic" %}
            {% assign wm_candidate = wm_candidate | replace: ".heif", ".jpg" | replace: ".heic", ".jpg" %}
            {% assign wm_image = wm_candidate | file_exists %}
          {% endif %}
        {% endif %}
      {% endif %}
      {% assign display_image = image_rel %}
      {% assign tags = item.tags | default: emptyarray %}
      {% if watermark_enabled and wm_image %}
        {% assign display_image = wm_image %}
      {% endif %}

      {% assign thumb_image = nil %}
      {% if display_image contains watermark_prefix %}
        {% assign thumb_candidate = display_image | replace_first: watermark_prefix, watermark_thumb_prefix %}
        {% assign thumb_rel = thumb_candidate %}
        {% assign thumb_first = thumb_rel | slice: 0, 1 %}
        {% if thumb_first == "/" %}
          {% assign thumb_rel = thumb_rel | slice: 1, 9999 %}
        {% endif %}
        {% assign thumb_image = thumb_rel | file_exists %}
      {% endif %}

      {% assign webp = nil %}
      {% if display_image contains ".jpg" or display_image contains ".jpeg" or display_image contains ".png" %}
        {% assign webp_candidate = display_image
          | replace: ".jpeg", ".webp"
          | replace: ".jpg", ".webp"
          | replace: ".png", ".webp"
        %}
        {% assign webp_rel = webp_candidate %}
        {% assign webp_first = webp_rel | slice: 0, 1 %}
        {% if webp_first == "/" %}
          {% assign webp_rel = webp_rel | slice: 1, 9999 %}
        {% endif %}
        {% assign webp = webp_rel | file_exists %}
      {% endif %}

      {% assign thumb_webp = nil %}
      {% if thumb_image %}
        {% assign thumb_webp_candidate = thumb_image
          | replace: ".jpeg", ".webp"
          | replace: ".jpg", ".webp"
          | replace: ".png", ".webp"
        %}
        {% assign thumb_webp_rel = thumb_webp_candidate %}
        {% assign thumb_webp_first = thumb_webp_rel | slice: 0, 1 %}
        {% if thumb_webp_first == "/" %}
          {% assign thumb_webp_rel = thumb_webp_rel | slice: 1, 9999 %}
        {% endif %}
        {% assign thumb_webp = thumb_webp_rel | file_exists %}
      {% endif %}
      {% assign link = item.link | default: "" %}
      {% if link == "" or link == image or link == image_rel %}
        {% assign link = display_image %}
      {% endif %}
      {% assign item_style = item.style | default: "" %}
      {% assign year = item.year | default: "" %}
      {% if year == "" %}
        {% assign filename = image_rel | split: "/" | last %}
        {% assign year = filename | regex_scan: "-(19[0-9]{2}|20[0-9]{2})[.][^.]+$" %}
      {% endif %}
      {% assign display_title = title %}
      {% if year and year != "" %}
        {% assign display_title = title | append: " | " | append: year %}
      {% endif %}
      {% assign alt_text = item.alt | default: display_title %}
      {% capture search %}{{ display_title }} {{ subtitle }} {{ tags | join: " " }}{% endcapture %}
      {% assign style_class = "" %}
      {% if item_style and item_style != "" %}
        {% assign style_class = " gallery-item--" | append: item_style %}
      {% endif %}

      <figure class="gallery-item{{ style_class }}" data-search="{{ search | strip_newlines | xml_escape }}">
        <a
          href="{{ link | relative_url | uri_escape }}{% if link == display_image %}?v={{ cache_bust }}{% endif %}"
          class="gallery-link"
          data-gallery-open
          data-gallery-src="{{ display_image | relative_url | uri_escape }}?v={{ cache_bust }}"
          data-gallery-title="{{ display_title | xml_escape }}"
          data-gallery-subtitle="{{ subtitle | xml_escape }}"
        >
          {% if webp or thumb_webp %}
            <picture>
              <source srcset="{% if thumb_webp %}{{ thumb_webp | relative_url | uri_escape }}{% else %}{{ webp | relative_url | uri_escape }}{% endif %}?v={{ cache_bust }}" type="image/webp">
              <img
                src="{% if thumb_image %}{{ thumb_image | relative_url | uri_escape }}{% else %}{{ display_image | relative_url | uri_escape }}{% endif %}?v={{ cache_bust }}"
                alt="{{ alt_text | default: "gallery image" | regex_strip }}"
                loading="lazy"
                decoding="async"
                {% include fallback.html %}
              >
            </picture>
          {% else %}
            <img
              src="{% if thumb_image %}{{ thumb_image | relative_url | uri_escape }}{% else %}{{ display_image | relative_url | uri_escape }}{% endif %}?v={{ cache_bust }}"
              alt="{{ alt_text | default: "gallery image" | regex_strip }}"
              loading="lazy"
              decoding="async"
              {% include fallback.html %}
            >
          {% endif %}
        </a>

        {% if title and title != "" %}
          <figcaption class="gallery-caption">
            <div class="gallery-caption-title">{{ display_title }}</div>
            {% if tags.size > 0 %}
              {% include tags.html tags=tags %}
            {% endif %}
          </figcaption>
        {% endif %}
      </figure>
    {% endfor %}
  </div>
{% endif %}

<div class="gallery" data-gallery>
  {% for item in grid_items %}
    {% assign title = item.title | default: "" %}
    {% assign subtitle = item.subtitle | default: "" %}
    {% assign image = item.image | default: "" %}
    {% assign image_rel = image %}
    {% assign image_first = image_rel | slice: 0, 1 %}
    {% if image_first == "/" %}
      {% assign image_rel = image_rel | slice: 1, 9999 %}
    {% endif %}
    {% assign wm_candidate = image_rel | replace_first: "images/", watermark_prefix %}
    {% assign wm_image = wm_candidate | file_exists %}
    {% if wm_image == nil %}
      {% assign tiff_ext = image_rel | slice: -5, 5 | downcase %}
      {% if tiff_ext == ".tiff" or image_rel | slice: -4, 4 | downcase == ".tif" %}
        {% assign wm_candidate = wm_candidate | replace: ".tiff", ".png" | replace: ".tif", ".png" %}
        {% assign wm_image = wm_candidate | file_exists %}
      {% else %}
        {% assign ext5 = image_rel | slice: -5, 5 | downcase %}
        {% if ext5 == ".heif" or ext5 == ".heic" %}
          {% assign wm_candidate = wm_candidate | replace: ".heif", ".jpg" | replace: ".heic", ".jpg" %}
          {% assign wm_image = wm_candidate | file_exists %}
        {% endif %}
      {% endif %}
    {% endif %}
    {% assign display_image = image_rel %}
    {% assign tags = item.tags | default: emptyarray %}
    {% if watermark_enabled and wm_image %}
      {% assign display_image = wm_image %}
    {% endif %}

    {% assign thumb_image = nil %}
    {% if display_image contains watermark_prefix %}
      {% assign thumb_candidate = display_image | replace_first: watermark_prefix, watermark_thumb_prefix %}
      {% assign thumb_rel = thumb_candidate %}
      {% assign thumb_first = thumb_rel | slice: 0, 1 %}
      {% if thumb_first == "/" %}
        {% assign thumb_rel = thumb_rel | slice: 1, 9999 %}
      {% endif %}
      {% assign thumb_image = thumb_rel | file_exists %}
    {% endif %}

      {% assign webp = nil %}
      {% if display_image contains ".jpg" or display_image contains ".jpeg" or display_image contains ".png" %}
      {% assign webp_candidate = display_image
        | replace: ".jpeg", ".webp"
        | replace: ".jpg", ".webp"
        | replace: ".png", ".webp"
      %}
      {% assign webp_rel = webp_candidate %}
      {% assign webp_first = webp_rel | slice: 0, 1 %}
      {% if webp_first == "/" %}
        {% assign webp_rel = webp_rel | slice: 1, 9999 %}
      {% endif %}
      {% assign webp = webp_rel | file_exists %}
    {% endif %}

    {% assign thumb_webp = nil %}
    {% if thumb_image %}
      {% assign thumb_webp_candidate = thumb_image
        | replace: ".jpeg", ".webp"
        | replace: ".jpg", ".webp"
        | replace: ".png", ".webp"
      %}
      {% assign thumb_webp_rel = thumb_webp_candidate %}
      {% assign thumb_webp_first = thumb_webp_rel | slice: 0, 1 %}
      {% if thumb_webp_first == "/" %}
        {% assign thumb_webp_rel = thumb_webp_rel | slice: 1, 9999 %}
      {% endif %}
      {% assign thumb_webp = thumb_webp_rel | file_exists %}
    {% endif %}
    {% assign link = item.link | default: "" %}
      {% if link == "" or link == image or link == image_rel %}
        {% assign link = display_image %}
      {% endif %}
      {% assign item_style = item.style | default: "" %}
      {% assign year = item.year | default: "" %}
      {% if year == "" %}
        {% assign filename = image_rel | split: "/" | last %}
        {% assign year = filename | regex_scan: "-(19[0-9]{2}|20[0-9]{2})[.][^.]+$" %}
      {% endif %}
      {% assign display_title = title %}
      {% if year and year != "" %}
        {% assign display_title = title | append: " | " | append: year %}
      {% endif %}
      {% assign alt_text = item.alt | default: display_title %}
      {% capture search %}{{ display_title }} {{ subtitle }} {{ tags | join: " " }}{% endcapture %}
      {% assign style_class = "" %}
      {% if item_style and item_style != "" %}
        {% assign style_class = " gallery-item--" | append: item_style %}
      {% endif %}

      <figure class="gallery-item{{ style_class }}" data-search="{{ search | strip_newlines | xml_escape }}">
        <a
          href="{{ link | relative_url | uri_escape }}{% if link == display_image %}?v={{ cache_bust }}{% endif %}"
          class="gallery-link"
          data-gallery-open
          data-gallery-src="{{ display_image | relative_url | uri_escape }}?v={{ cache_bust }}"
          data-gallery-title="{{ display_title | xml_escape }}"
          data-gallery-subtitle="{{ subtitle | xml_escape }}"
        >
          {% if webp or thumb_webp %}
            <picture>
              <source srcset="{% if thumb_webp %}{{ thumb_webp | relative_url | uri_escape }}{% else %}{{ webp | relative_url | uri_escape }}{% endif %}?v={{ cache_bust }}" type="image/webp">
              <img
                src="{% if thumb_image %}{{ thumb_image | relative_url | uri_escape }}{% else %}{{ display_image | relative_url | uri_escape }}{% endif %}?v={{ cache_bust }}"
                alt="{{ alt_text | default: "gallery image" | regex_strip }}"
                loading="lazy"
                {% include fallback.html %}
              >
            </picture>
          {% else %}
            <img
              src="{% if thumb_image %}{{ thumb_image | relative_url | uri_escape }}{% else %}{{ display_image | relative_url | uri_escape }}{% endif %}?v={{ cache_bust }}"
              alt="{{ alt_text | default: "gallery image" | regex_strip }}"
              loading="lazy"
              {% include fallback.html %}
            >
          {% endif %}
        </a>

      {% if title and title != "" %}
          <figcaption class="gallery-caption">
            <div class="gallery-caption-title">{{ display_title }}</div>
            {% if tags.size > 0 %}
              {% include tags.html tags=tags %}
          {% endif %}
        </figcaption>
      {% endif %}
    </figure>
  {% endfor %}
</div>

<dialog class="gallery-lightbox" data-gallery-lightbox aria-label="Image viewer" aria-modal="true">
  <button type="button" class="gallery-lightbox-close button" data-style="bare" data-gallery-close aria-label="Close">
    {% include icon.html icon="fa-solid fa-xmark" %}
  </button>
  <img class="gallery-lightbox-img" data-gallery-img alt="">
  <div class="gallery-lightbox-meta" data-gallery-meta></div>
</dialog>
