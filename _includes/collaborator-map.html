{% assign home = site.data.map_home %}
{% assign emptyarray = "" | split: "," %}
{% assign points = site.data.collaborators | default: emptyarray %}
{% if site.data.collaborators_map and site.data.collaborators_map.size > 0 %}
  {% assign points = site.data.collaborators_map %}
{% endif %}

{% assign current_points = points | data_filter: "status != 'past'" %}
{% assign past_points = points | data_filter: "status == 'past'" %}

<div class="collab-map" data-map-kind="collaborators">
  <div class="collab-map-controls" role="group" aria-label="Map controls">
    <div class="collab-map-control">
      <span class="collab-map-control-label">View</span>
      <button class="button" data-style="bare" type="button" data-collab-view="world" aria-pressed="true">World</button>
      <button class="button" data-style="bare" type="button" data-collab-view="us" aria-pressed="false">US</button>
    </div>

    <div class="collab-map-control">
      <span class="collab-map-control-label">Show</span>
      <label class="collab-map-toggle">
        <input type="checkbox" checked data-collab-filter="current">
        Current
      </label>
      <label class="collab-map-toggle">
        <input type="checkbox" checked data-collab-filter="past">
        Past
      </label>
    </div>

    <div class="collab-map-control">
      <span class="collab-map-control-label">Type</span>
      <label class="collab-map-toggle">
        <input type="checkbox" checked data-collab-type="collaborator">
        Collaborators
      </label>
      <label class="collab-map-toggle">
        <input type="checkbox" checked data-collab-type="institution">
        Institutions
      </label>
    </div>

    <div class="collab-map-control">
      <span class="collab-map-control-label">Layout</span>
      <label class="collab-map-toggle">
        <input type="checkbox" checked data-collab-cluster="duplicates">
        Cluster duplicates
      </label>
    </div>
  </div>

  <div data-collab-tags class="collab-map-tags"></div>

  <div class="collab-map-summary" data-collab-summary></div>

  <div class="collab-map-plot" data-collab-map data-site-root="{{ "/" | relative_url }}">
    <div class="collab-map-loading">Loading map…</div>
  </div>

  {% capture payload %}
    {
      "home": {{ home | jsonify }},
      "people": {{ points | jsonify }}
    }
  {% endcapture %}
  <script type="application/json" class="collab-map-data">
    {{ payload | strip_newlines }}
  </script>
  <script>
    (function () {
      if (window.renderCollaboratorsMaps) window.renderCollaboratorsMaps();
      var root = document.currentScript && document.currentScript.parentElement;
      var loading = root && root.querySelector && root.querySelector(".collab-map-loading");
      window.setTimeout(function () {
        if (!loading) return;
        if (!window.renderCollaboratorsMaps) {
          loading.textContent = "Map script failed to load.";
          return;
        }
        if (!window.Plotly) {
          loading.textContent = "Loading map library… (Plotly)";
          return;
        }
      }, 1500);
    })();
  </script>

  <noscript>
    <p>This map is interactive and requires JavaScript. Use the collaborator directory below.</p>
  </noscript>
</div>
