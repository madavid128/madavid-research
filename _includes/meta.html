{% assign filename = page.path | split: "/" | last %}
{% if page.name and page.name != filename %}
  {% assign title = page.name %}
{% elsif page.title %}
  {% assign title = page.title %}
{% else %}
  {% assign title = nil %}
{% endif %}

{% assign title = title | xml_escape %}

{% assign fulltitle = "" | split: "," %}
{% if title and title != "" %}
  {% assign fulltitle = fulltitle | push: title %}
{% endif %}
{% if site.title and site.title != "" %}
  {% assign fulltitle = fulltitle | push: site.title %}
{% endif %}
{% assign fulltitle = fulltitle | join: " | " %}

{% assign subtitle = site.subtitle %}

{% assign description = page.description | default: site.description %}
{% if site.subtitle %}
  {% capture description -%}
    {{ site.subtitle }}. {{ description }}
  {%- endcapture %}
{% endif %}
{% assign canonical = page.url | absolute_url %}

{% assign description = description | xml_escape %}

{% assign icon_png = "images/icon.png" | file_exists %}
{% assign icon_jpg = "images/icon.jpg" | file_exists %}
{% assign icon_file = icon_png | default: icon_jpg %}
{% assign icon_path = icon_file | prepend: "/" %}
{% assign icon = icon_path | absolute_url %}

{% assign share_jpg = "images/share.jpg" | file_exists %}
{% assign share_png = "images/share.png" | file_exists %}
{% assign share_file = share_jpg | default: share_png | default: icon_file %}

{% comment %}
  Social preview selection priority (no redundancy):
  1) CSV-driven per-page selection: `_data/page_share_images.yaml` (keyed by section)
  2) Page front matter `share:` (manual override)
  3) Conventional per-section share images (if present): `images/share-<section>.jpg`
  4) Site default: `_config.yaml` `share:` (usually `images/share.jpg`)
{% endcomment %}

{% assign share_key = "" %}
{% if page.dir == "/" %}
  {% assign share_key = "home" %}
{% elsif page.dir == "/research/" %}
  {% assign share_key = "publications" %}
{% elsif page.dir == "/projects/" %}
  {% assign share_key = "projects" %}
{% elsif page.dir == "/team/" %}
  {% assign share_key = "team" %}
{% elsif page.dir == "/art/" %}
  {% assign share_key = "art" %}
{% elsif page.dir == "/pictures/" %}
  {% assign share_key = "pictures" %}
{% elsif page.dir == "/updates/" %}
  {% assign share_key = "updates" %}
{% endif %}

{% assign share_from_csv = nil %}
{% if share_key != "" and site.data.page_share_images %}
  {% assign share_from_csv = site.data.page_share_images[share_key] %}
{% endif %}

{% assign share_from_section = nil %}
{% if share_key != "" %}
  {% assign section_candidate = "images/share-" | append: share_key | append: ".jpg" %}
  {% assign share_from_section = section_candidate | file_exists %}
{% endif %}

{% assign share_value = share_file %}
{% if site.share %}
  {% assign share_value = site.share %}
{% endif %}
{% if share_from_section %}
  {% assign share_value = share_from_section %}
{% endif %}
{% if page.share %}
  {% assign share_value = page.share %}
{% endif %}
{% if share_from_csv %}
  {% assign share_value = share_from_csv %}
{% endif %}

{% assign watermark_enabled = site.watermark.enabled | default: false %}
{% assign watermark_prefix = site.watermark.prefix | default: "images/wm/" %}
{% if watermark_enabled and share_value and share_value != "" and share_value contains "images/" %}
  {% assign share_rel = share_value %}
  {% assign share_first = share_rel | slice: 0, 1 %}
  {% if share_first == "/" %}
    {% assign share_rel = share_rel | slice: 1, 9999 %}
  {% endif %}
  {% assign wm_candidate = share_rel | replace_first: "images/", watermark_prefix %}
  {% assign wm_share = wm_candidate | file_exists %}
  {% if wm_share == nil %}
    {% assign ext5 = share_rel | slice: -5, 5 | downcase %}
    {% if ext5 == ".tiff" or share_rel | slice: -4, 4 | downcase == ".tif" %}
      {% assign wm_candidate = wm_candidate | replace: ".tiff", ".png" | replace: ".tif", ".png" %}
      {% assign wm_share = wm_candidate | file_exists %}
    {% elsif ext5 == ".heif" or ext5 == ".heic" %}
      {% assign wm_candidate = wm_candidate | replace: ".heif", ".jpg" | replace: ".heic", ".jpg" %}
      {% assign wm_share = wm_candidate | file_exists %}
    {% endif %}
  {% endif %}
  {% if wm_share %}
    {% assign share_value = wm_share %}
  {% endif %}
{% endif %}

{% assign share_url = share_value %}
{% if share_value contains "://" %}
  {% assign share_url = share_value %}
{% else %}
  {% assign share_path = share_value %}
  {% assign share_path_first = share_path | slice: 0, 1 %}
  {% if share_path_first != "/" %}
    {% assign share_path = share_path | prepend: "/" %}
  {% endif %}
  {% assign share_url = share_path | absolute_url %}
{% endif %}

{% assign published = page.date | date_to_xmlschema %}
{% assign updated = page.last_modified_at | date_to_xmlschema %}

{% assign feed = "feed.xml" | absolute_url %}

{% assign author_name = nil %}
{% assign author_url = nil %}
{% if page.author %}
  {% assign author_slug = page.author | downcase | strip %}
  {% assign author_member = site.members
    | where_exp: "member", "member.slug == author_slug"
    | first
  %}
  {% if author_member %}
    {% assign author_name = author_member.name %}
    {% assign author_url = author_member.url | absolute_url %}
  {% else %}
    {% assign author_name = page.author %}
  {% endif %}
{% endif %}

<meta name="viewport" content="width=device-width, initial-scale=1">

<title>{{ fulltitle }}</title>

<link rel="canonical" href="{{ canonical }}">

<meta name="title" content="{{ title }}">
<meta name="description" content="{{ description }}">

<meta property="og:title" content="{{ title }}">
<meta property="og:site_name" content="{{ site.title | xml_escape }}">
<meta property="og:description" content="{{ description }}">
<meta property="og:url" content="{{ canonical }}">
<meta property="og:image" content="{{ share_url }}">
<meta property="og:locale" content="en_US">

<meta property="twitter:title" content="{{ title }}">
<meta property="twitter:description" content="{{ description }}">
<meta property="twitter:url" content="{{ canonical }}">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="{{ share_url }}">

{% if page.author %}
  <meta name="author" content="{{ page.author | xml_escape }}">
  <meta property="og:type" content="article">
  <meta property="og:updated_time" content="{{ updated }}">
  <meta property="article:published_time" content="{{ published }}">
  <meta property="article:modified_time" content="{{ updated }}">
  <meta name="revised" content="{{ updated }}">
{% else %}
  <meta property="og:type" content="website">
{% endif %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": {% if page.author %}"BlogPosting"{% else %}"WebSite"{% endif %},
  "name": {{ title | jsonify }},
  "headline": {{ title | jsonify }},
  "description": {{ description | jsonify }},
  "url": {{ canonical | jsonify }},
  "publisher": {
    "@type": "Organization",
    "logo": { "@type": "ImageObject", "url": {{ icon | jsonify }} }
  }
  {% if page.author %}
  , "author": {
    "@type": "Person",
    "name": {{ author_name | default: page.author | jsonify }}
    {% if author_url %}
    , "url": {{ author_url | jsonify }}
    {% endif %}
  }
  , "datePublished": {{ published | jsonify }}
  {% if updated and updated != "" %}
  , "dateModified": {{ updated | jsonify }}
  {% endif %}
  {% endif %}
}
</script>

{% comment %}
  Lightweight Person structured data to improve search result enrichment.
  Kept separate from the WebSite/BlogPosting block above.
{% endcomment %}
{% assign same_as = "" | split: "," %}
{% if site.links.orcid and site.links.orcid != "" %}
  {% capture orcid_url %}https://orcid.org/{{ site.links.orcid }}{% endcapture %}
  {% assign same_as = same_as | push: orcid_url %}
{% endif %}
{% if site.links.google-scholar and site.links.google-scholar != "" %}
  {% capture scholar_url %}https://scholar.google.com/citations?user={{ site.links.google-scholar }}{% endcapture %}
  {% assign same_as = same_as | push: scholar_url %}
{% endif %}
{% if site.links.github and site.links.github != "" %}
  {% capture github_url %}https://github.com/{{ site.links.github }}{% endcapture %}
  {% assign same_as = same_as | push: github_url %}
{% endif %}
{% if site.links.linkedin and site.links.linkedin != "" %}
  {% capture linkedin_url %}https://www.linkedin.com/in/{{ site.links.linkedin }}{% endcapture %}
  {% assign same_as = same_as | push: linkedin_url %}
{% endif %}
{% if site.links.pubmed and site.links.pubmed != "" %}
  {% assign same_as = same_as | push: site.links.pubmed %}
{% endif %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": {{ site.title | jsonify }},
  "url": {{ site.url | append: site.baseurl | jsonify }},
  "image": {{ share_url | jsonify }},
  "jobTitle": "Instructor (Orthopedics)",
  "affiliation": [
    { "@type": "Organization", "name": "University of Colorado Anschutz Medical Campus" }
  ],
  "sameAs": {{ same_as | uniq | jsonify }}
  {% if site.links.orcid and site.links.orcid != "" %}
  , "identifier": [
    {
      "@type": "PropertyValue",
      "propertyID": "ORCID",
      "value": {{ site.links.orcid | jsonify }}
    }
  ]
  {% endif %}
}
</script>

<link rel="alternate" type="application/rss+xml" href="{{ feed }}">
